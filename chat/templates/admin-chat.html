{% extends 'base.html' %}
{% load static %}
{% block title %}صفحه اصلی{% endblock %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/admin-chat.css' %}">
{% endblock %}
{% block body %}

<div class="container">
    <div class="left-side">
        <div class="setting">
            <div class="admin-pic" id="{{user.name}}">
                <img class="img" src="{{user.image.url}}" id="{{user.image.url}}" alt="">
            </div>
            <div class="setting-icons">
                <div class="online-status">
                    {% if user.online %}
                        <span class="indicator online"></span>
                        <span>online</span>
                    {% else %}
                        <span class="indicator"></span>
                        <span>offline</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="customers">
            {% for connect in connection reversed %}
            <div class="user" data-email="{{connect.userEmail}}" data-number="{{connect.userNumber}}">
                <div class="user-pic">
                    <img src="{% static 'img/chat2.png' %}" alt="">
                </div>
                <div class="user-info">
                    <div class="user-email">{{connect.userEmail}}</div>
                    <div class="user-number">{{connect.userNumber}}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="right-side">
        <div class="header"></div>
        <div class="body" id="body"></div>
        <div class="footer">
            <div class="textarea">
                <textarea class="text" placeholder="پیام خود را بنویسید..."></textarea>
            </div>
            <div class="send-message">
                <svg enable-background="new 0 0 38 38" version="1.1" width="40" height="40" viewBox="0 0 38 38" xml:space="preserve" xmlns="http://www.w3.org/2000/svg">
                    <path class="st0" d="m34.9 4l-1.7 10-21 5 21 5 1.7 10-31.8-15 31.8-15zm-0.8-1.5c0.8-0.4 1.8 0 2.2 0.8 0.1 0.3 0.2 0.7 0.1 1l-1.7 10c-0.1 0.7-0.6 1.2-1.3 1.4l-21 5v-3.2l21 5c0.7 0.2 1.1 0.7 1.3 1.4l1.7 10c0.1 0.9-0.5 1.8-1.4 1.9-0.3 0.1-0.7 0-1-0.1l-31.7-15c-0.8-0.4-1.2-1.4-0.8-2.2 0.2-0.3 0.4-0.6 0.8-0.8l31.8-15.2z"/>
                </svg>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedUser = null;
    let socket = null;
    const chatBody = document.getElementById('body');
    const sendBtn = document.querySelector('.send-message');
    const textInput = document.querySelector('.text');

    document.querySelectorAll('.user').forEach(userDiv => {
        userDiv.addEventListener('click', function() {
            const email = this.dataset.email;
            const number = this.dataset.number;
            selectedUser = email + '-' + number;
            if(socket) socket.close();
            socket = new WebSocket('ws://' + window.location.host + '/ws/admin-chat/' + selectedUser + '/');

            socket.onopen = function(e){
                console.log("WebSocket connection established with user:", selectedUser);
            };

            socket.onmessage = function(e){
                const data = JSON.parse(e.data);
                if(data.message){
                    const div = document.createElement('div');
                    div.classList.add('received-chat-box');
                    div.innerHTML = `<div class="header"><p>${data.sender}</p><p>${data.time}</p></div><div class="body">${data.message}</div>`;
                    chatBody.appendChild(div);
                }
            };

            socket.onclose = function(e){
                console.log("WebSocket closed");
            };
        });
    });

    sendBtn.addEventListener('click', function(){
        if(socket && textInput.value){
            socket.send(JSON.stringify({'message': textInput.value}));
            textInput.value = '';
        }
    });
</script>

{% endblock %}